@model IEnumerable<ReservationSystem.Models.CartItem>
@{
    ViewData["Title"] = "Sepetim";
}

<div class="login-register-bg">
    <div class="login-register-form" style="width:100%;max-width:1100px;">
        <h1>Sepetim</h1>
        
        @if (Model.Any())
        {
            <div class="table-responsive">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Kapak</th>
                            <th>Salon Adı</th>
                            <th>Etkinlik Adı</th>
                            <th>Başlangıç</th>
                            <th>Bitiş</th>
                            <th>Süre</th>
                            <th>Saatlik Ücret</th>
                            <th>Toplam Ücret</th>
                            <th>İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr id="cart-item-@item.Id">
                                <td>
                                    @if (!string.IsNullOrEmpty(item.MeetingRoom?.CoverImagePath))
                                    {
                                        <img src="@item.MeetingRoom.CoverImagePath" alt="@item.MeetingRoom.Name" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" />
                                    }
                                    else if (item.MeetingRoom?.Images != null && item.MeetingRoom.Images.Any())
                                    {
                                        <img src="@item.MeetingRoom.Images.First().ImagePath" alt="@item.MeetingRoom.Name" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" />
                                    }
                                    else
                                    {
                                        <img src="/images/photo.jpg" alt="@item.MeetingRoom?.Name" style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;" />
                                    }
                                </td>
                                <td>@item.MeetingRoom?.Name</td>
                                <td>@item.EventName</td>
                                <td>@item.StartTime.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@item.EndTime.ToString("dd.MM.yyyy HH:mm")</td>
                                <td>@item.DurationHours.ToString("F1") saat</td>
                                <td>@item.MeetingRoom?.HourlyRate.ToString("C", new System.Globalization.CultureInfo("tr-TR"))</td>
                                <td>@item.TotalAmount.ToString("C", new System.Globalization.CultureInfo("tr-TR"))</td>
                                <td>
                                    <button class="btn btn-danger btn-sm" onclick="removeFromCart(@item.Id)">Sil</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            
            <div class="row mt-4">
                <div class="col-md-6">
                    <h4>Toplam Ödeme: @ViewBag.TotalAmount.ToString("C", new System.Globalization.CultureInfo("tr-TR"))</h4>
                </div>
                <div class="col-md-6 text-end">
                    <a href="/Cart/Payment" class="btn btn-success btn-lg">Öde</a>
                    <a href="/MeetingRooms" class="btn btn-secondary">Alışverişe Devam Et</a>
                </div>
            </div>
        }
        else
        {
            <div class="text-center">
                <p>Sepetiniz boş.</p>
                <a href="/MeetingRooms" class="btn btn-primary">Rezervasyon Yap</a>
            </div>
        }
    </div>
</div>

<script>
function removeFromCart(itemId) {
    if (confirm('Bu rezervasyonu sepetten kaldırmak istediğinizden emin misiniz?')) {
        fetch('/Cart/Remove', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: 'id=' + itemId
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('cart-item-' + itemId).remove();
                location.reload();
            } else {
                alert(data.message);
            }
        });
    }
}
</script>